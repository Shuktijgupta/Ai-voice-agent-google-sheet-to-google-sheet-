// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Driver {
  id        String   @id @default(uuid())
  name      String
  phone     String
  email     String?
  status    String   @default("new") // new, calling, contacted, qualified, disqualified
  source    String?  @default("manual") // manual, google_sheets
  externalId String? @map("external_id") // ID from external source (e.g. row number)
  createdAt DateTime @default(now()) @map("created_at")

  calls              Call[]
  interviewResponses InterviewResponse[]
  scheduledCalls      ScheduledCall[]

  @@map("drivers")
}

model Call {
  id              String    @id @default(uuid())
  driverId        String    @map("driver_id")
  agentId         String?   @map("agent_id")
  blandCallId     String?   @unique @map("bland_call_id")
  provider        String?   @default("bland") // bland, elevenlabs, tata

  vapiCallId      String?   @unique @map("vapi_call_id")
  startTime       DateTime  @default(now()) @map("start_time")
  endTime         DateTime? @map("end_time")
  durationSeconds Int?      @map("duration_seconds")
  recordingUrl    String?   @map("recording_url")
  transcript      String?
  summary         String?
  status          String? // completed, failed, no-answer
  price           Float?
  callEndedBy     String?   @map("call_ended_by")
  answeredBy      String?   @map("answered_by")
  analysis        String?   // JSON string
  variables       String?   // JSON string
  cost            Float?    // Cost in local currency
  costCurrency    String?   @default("USD") @map("cost_currency")

  driver             Driver              @relation(fields: [driverId], references: [id])
  agent              Agent?              @relation(fields: [agentId], references: [id])
  interviewResponses InterviewResponse[]
  scheduledCall      ScheduledCall?
  costRecord         CostRecord?

  @@map("calls")
  @@index([provider])
  @@index([startTime])
}

model Agent {
  id           String   @id @default(uuid())
  name         String
  systemPrompt String
  questions    String   // JSON stringified: { id: string, text: string }[]
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  calls Call[]
  scheduledCalls ScheduledCall[]

  @@map("agents")
}

model InterviewResponse {
  id           String   @id @default(uuid())
  callId       String?  @map("call_id")
  driverId     String?  @map("driver_id")
  questionId   String?  @map("question_id") // cdl_license, experience_years, violations, work_preference
  questionText String?  @map("question_text")
  answerText   String?  @map("answer_text")
  createdAt    DateTime @default(now()) @map("created_at")

  call   Call?   @relation(fields: [callId], references: [id])
  driver Driver? @relation(fields: [driverId], references: [id])

  @@map("interview_responses")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

model Settings {
  id        String   @id @default("default")
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

model ScheduledCall {
  id          String   @id @default(uuid())
  driverId    String   @map("driver_id")
  agentId     String?  @map("agent_id")
  scheduledAt DateTime  @map("scheduled_at")
  timezone    String   @default("UTC")
  status      String   @default("pending") // pending, queued, completed, failed, cancelled
  retryCount  Int      @default(0) @map("retry_count")
  maxRetries  Int      @default(3) @map("max_retries")
  recurring   String?  // null, daily, weekly, monthly
  callId      String?  @map("call_id") // Reference to actual call when executed
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  driver Driver @relation(fields: [driverId], references: [id])
  agent  Agent? @relation(fields: [agentId], references: [id])
  call   Call?  @relation(fields: [callId], references: [id])

  @@map("scheduled_calls")
  @@index([scheduledAt])
  @@index([status])
}

model CostRecord {
  id          String   @id @default(uuid())
  callId      String?  @unique @map("call_id")
  provider    String   // bland, exotel, knowlarity, etc.
  cost        Float
  currency    String   @default("USD")
  duration    Int?     // Duration in seconds
  metadata    String?  // JSON string for additional cost details
  createdAt   DateTime @default(now()) @map("created_at")

  call Call? @relation(fields: [callId], references: [id])

  @@map("cost_records")
  @@index([provider])
  @@index([createdAt])
}
